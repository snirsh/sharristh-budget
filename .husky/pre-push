# Smart pre-push: typecheck only affected packages (~10-30 seconds)
# Uses Turbo's --filter with git diff to find changed packages

# Get the list of changed files compared to origin
CHANGED_FILES=$(git diff --name-only origin/master...HEAD 2>/dev/null || git diff --name-only HEAD~10...HEAD 2>/dev/null || echo "")

if [ -z "$CHANGED_FILES" ]; then
  echo "No changes detected, skipping typecheck"
  exit 0
fi

# Determine which packages have changes
AFFECTED_FILTERS=""

# Check each package/app for changes
if echo "$CHANGED_FILES" | grep -q "^packages/domain/"; then
  AFFECTED_FILTERS="$AFFECTED_FILTERS --filter=@sfam/domain"
fi

if echo "$CHANGED_FILES" | grep -q "^packages/db/"; then
  AFFECTED_FILTERS="$AFFECTED_FILTERS --filter=@sfam/db"
fi

if echo "$CHANGED_FILES" | grep -q "^packages/scraper/"; then
  AFFECTED_FILTERS="$AFFECTED_FILTERS --filter=@sfam/scraper"
fi

if echo "$CHANGED_FILES" | grep -q "^packages/api/"; then
  AFFECTED_FILTERS="$AFFECTED_FILTERS --filter=@sfam/api"
fi

if echo "$CHANGED_FILES" | grep -q "^packages/ui/"; then
  AFFECTED_FILTERS="$AFFECTED_FILTERS --filter=@sfam/ui"
fi

if echo "$CHANGED_FILES" | grep -q "^apps/web/"; then
  AFFECTED_FILTERS="$AFFECTED_FILTERS --filter=@sfam/web"
fi

if echo "$CHANGED_FILES" | grep -q "^apps/mobile/"; then
  AFFECTED_FILTERS="$AFFECTED_FILTERS --filter=@sfam/mobile"
fi

# If no specific packages affected, check if there are any TS changes at root
if [ -z "$AFFECTED_FILTERS" ]; then
  if echo "$CHANGED_FILES" | grep -qE "\.(ts|tsx)$"; then
    echo "Root-level TypeScript changes detected, running full typecheck"
    pnpm exec turbo typecheck --filter=@sfam/domain --filter=@sfam/db --filter=@sfam/scraper --ui=stream
    exit $?
  else
    echo "No TypeScript changes detected, skipping typecheck"
    exit 0
  fi
fi

echo "Running typecheck on affected packages:$AFFECTED_FILTERS"
# shellcheck disable=SC2086
pnpm exec turbo typecheck $AFFECTED_FILTERS --ui=stream
